<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記數app - 升級版遊戲管理系統</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Updated Google API Scripts for Mobile-Optimized Google Identity Services -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="screen">
        <div class="container">
            <div class="welcome-content">
                <h1 class="welcome-title">記數app</h1>
                <p class="welcome-subtitle">升級版多遊戲管理系統</p>
                
                <!-- Google Authentication Section - Enhanced for Mobile -->
                <div class="google-auth-section">
                    <div id="googleSignInButton" class="google-signin-container hidden">
                        <button class="btn btn--outline btn--full-width" onclick="signInGoogle()">
                            <span class="google-icon">G</span>
                            使用Google帳號登入
                        </button>
                    </div>
                    
                    <!-- Manual Sign-in Button for Mobile Fallback -->
                    <div id="manualSignInBtn" class="hidden">
                        <button class="btn btn--primary btn--lg btn--full-width" onclick="signInGoogle()">
                            <span class="google-icon">G</span>
                            手動登入Google帳號
                        </button>
                    </div>
                    
                    <div id="googleUserInfo" class="google-user-info hidden">
                        <div class="user-avatar-container">
                            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                            <div class="user-details">
                                <span class="user-name">已登入: <span id="googleUserName"></span></span>
                                <span class="user-email" id="googleUserEmail"></span>
                            </div>
                        </div>
                        <button class="btn btn--secondary btn--sm" onclick="signOutGoogle()">登出</button>
                    </div>
                </div>

                <div class="sync-status" id="syncStatus">
                    <span class="sync-indicator" id="syncIndicator">
                        <span class="sync-icon">☁️</span>
                        <span id="syncStatusText">未登入Google Drive</span>
                    </span>
                </div>
                
                <div class="welcome-actions">
                    <button class="btn btn--primary btn--lg btn--full-width" onclick="showGameManagement()">管理遊戲</button>
                    <button class="btn btn--secondary btn--lg btn--full-width" onclick="createNewGame()">創建新遊戲</button>
                    <button class="btn btn--outline btn--lg btn--full-width" onclick="showGameList()">選擇現有遊戲</button>
                </div>

                <div class="api-config-notice">
                    <p class="config-warning">✅ Google Drive API 已配置 (支援手機版)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Management Screen -->
    <div id="gameManagementScreen" class="screen hidden">
        <div class="container">
            <div class="header">
                <button class="btn-back" onclick="showWelcome()">← 返回</button>
                <h2>遊戲管理</h2>
                <button class="btn-settings" onclick="manualSyncWithCloud()">☁️</button>
            </div>
            <div class="cloud-sync-status" id="cloudSyncStatus">
                <span id="cloudSyncText">雲端同步狀態</span>
            </div>
            <div class="game-actions">
                <button class="btn btn--primary btn--full-width" onclick="createNewGame()">創建新遊戲</button>
                <button class="btn btn--secondary btn--full-width" onclick="manualSyncWithCloud()">手動同步雲端</button>
            </div>
            <div id="gamesList" class="games-list">
                <!-- Games will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- Game List Screen -->
    <div id="gameListScreen" class="screen hidden">
        <div class="container">
            <div class="header">
                <button class="btn-back" onclick="showWelcome()">← 返回</button>
                <h2>選擇遊戲</h2>
            </div>
            <div id="gamesSelectionList" class="games-list">
                <!-- Games will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- Player Setup Screen -->
    <div id="playerSetupScreen" class="screen hidden">
        <div class="container">
            <div class="header">
                <button class="btn-back" onclick="backToGameManagement()">← 返回</button>
                <h2>添加玩家</h2>
                <button class="btn-settings" onclick="showSettings()">⚙️</button>
            </div>
            <div class="game-info-bar">
                <div class="current-game-info">
                    遊戲: <span id="currentGameTitle">新遊戲</span>
                </div>
                <div class="banker-rounds-info">
                    莊家輪數: <span id="currentBankerRounds">3</span> 輪
                </div>
            </div>
            <div class="player-setup">
                <div class="form-group">
                    <label class="form-label">玩家名稱</label>
                    <input type="text" id="playerNameInput" class="form-control" placeholder="輸入玩家名稱" maxlength="20">
                    <button class="btn btn--primary btn--sm" onclick="addPlayer()">添加</button>
                </div>
                <div class="player-list" id="playerList"></div>
                <div class="setup-actions">
                    <button class="btn btn--secondary btn--full-width" id="confirmPlayersBtn" onclick="confirmPlayers()" disabled>確認玩家 (最少2人)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settingsScreen" class="screen hidden">
        <div class="container">
            <div class="header">
                <button class="btn-back" onclick="goBackFromSettings()">← 返回</button>
                <h2>設定</h2>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Google Drive 同步</div>
                        <div class="setting-description">自動同步遊戲數據到雲端 (支援手機版)</div>
                    </div>
                    <div class="google-drive-controls">
                        <button id="googleDriveToggle" class="btn btn--sm" onclick="toggleGoogleDriveSync()">啟用</button>
                        <span id="lastSyncTime" class="last-sync-time"></span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">莊家輪數</div>
                        <div class="setting-description">每位玩家當莊家的輪數</div>
                    </div>
                    <select id="bankerRoundsSelect" class="form-control setting-select" onchange="updateBankerRounds(this.value)">
                        <option value="1">1 輪</option>
                        <option value="2">2 輪</option>
                        <option value="3" selected>3 輪</option>
                        <option value="4">4 輪</option>
                        <option value="5">5 輪</option>
                        <option value="6">6 輪</option>
                        <option value="7">7 輪</option>
                        <option value="8">8 輪</option>
                        <option value="9">9 輪</option>
                        <option value="10">10 輪</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">用戶名稱</div>
                        <div class="setting-description">設定您的名稱</div>
                    </div>
                    <input type="text" id="userNameInput" class="form-control" placeholder="輸入您的名稱" onchange="updateUserName(this.value)">
                </div>
            </div>
        </div>
    </div>

    <!-- Banker Selection Screen -->
    <div id="bankerSelectionScreen" class="screen hidden">
        <div class="container">
            <div class="header">
                <button class="btn-back" onclick="goBackFromBankerSelection()">← 返回</button>
                <h2>選擇莊家</h2>
                <div class="round-info">第 <span id="currentRoundNumber">1</span> 輪</div>
            </div>
            <div class="banker-list" id="bankerList"></div>
        </div>
    </div>

    <!-- Record Screen -->
    <div id="recordScreen" class="screen hidden">
        <div class="container">
            <div class="record-content">
                <div class="header">
                    <button class="btn-back" onclick="showBankerSelection()">← 返回</button>
                    <h2>記錄輸贏</h2>
                    <div class="round-info">
                        第 <span id="recordRoundNumber">1</span> 輪 - 莊家: <span id="currentBankerName"></span>
                    </div>
                </div>
                <div class="game-lock-status" id="gameLockStatus"></div>
                <div class="sync-progress" id="syncProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">正在同步...</span>
                </div>
                <div class="player-record-list" id="playerRecordList"></div>
                <button class="btn btn--primary btn--lg btn--full-width" id="nextRoundBtn" onclick="nextRound()" disabled>下一輪</button>
            </div>
            <div class="bottom-nav">
                <button class="nav-item active" onclick="showRecord()">
                    <span class="nav-icon">📝</span>
                    <span class="nav-label">記錄</span>
                </button>
                <button class="nav-item" onclick="showDetailedRecords()">
                    <span class="nav-icon">📊</span>
                    <span class="nav-label">詳細</span>
                </button>
                <button class="nav-item" onclick="showStatistics()">
                    <span class="nav-icon">📈</span>
                    <span class="nav-label">統計</span>
                </button>
                <button class="nav-item" onclick="showSettings()">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-label">設定</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Detailed Records Screen -->
    <div id="detailedRecordsScreen" class="screen hidden">
        <div class="container">
            <div class="detailed-content">
                <div class="header">
                    <button class="btn-back" onclick="showRecord()">← 返回</button>
                    <h2>詳細記錄</h2>
                </div>
                <div class="table-container">
                    <table class="records-table" id="recordsTable">
                        <thead>
                            <tr id="tableHeaderRow">
                                <th>輪數</th>
                                <th>莊家</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                        </tbody>
                        <tfoot>
                            <tr class="totals-row" id="totalsRow">
                                <td><strong>總計</strong></td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="bottom-nav">
                <button class="nav-item" onclick="showRecord()">
                    <span class="nav-icon">📝</span>
                    <span class="nav-label">記錄</span>
                </button>
                <button class="nav-item active" onclick="showDetailedRecords()">
                    <span class="nav-icon">📊</span>
                    <span class="nav-label">詳細</span>
                </button>
                <button class="nav-item" onclick="showStatistics()">
                    <span class="nav-icon">📈</span>
                    <span class="nav-label">統計</span>
                </button>
                <button class="nav-item" onclick="showSettings()">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-label">設定</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Screen -->
    <div id="statisticsScreen" class="screen hidden">
        <div class="container">
            <div class="stats-content">
                <div class="header">
                    <button class="btn-back" onclick="goBackFromStatistics()">← 返回</button>
                    <h2>統計</h2>
                </div>
                <div class="statistics-content" id="statisticsContent"></div>
                <div class="export-actions">
                    <button class="btn btn--primary btn--full-width" onclick="exportToExcel()">匯出Excel</button>
                    <button class="btn btn--secondary btn--full-width" onclick="saveGame()">保存遊戲</button>
                </div>
            </div>
            <div class="bottom-nav">
                <button class="nav-item" onclick="showRecord()">
                    <span class="nav-icon">📝</span>
                    <span class="nav-label">記錄</span>
                </button>
                <button class="nav-item" onclick="showDetailedRecords()">
                    <span class="nav-icon">📊</span>
                    <span class="nav-label">詳細</span>
                </button>
                <button class="nav-item active" onclick="showStatistics()">
                    <span class="nav-icon">📈</span>
                    <span class="nav-label">統計</span>
                </button>
                <button class="nav-item" onclick="showSettings()">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-label">設定</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Create Game Modal -->
    <div id="createGameModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>創建新遊戲</h3>
                <button class="modal-close" onclick="closeCreateGameModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">遊戲名稱</label>
                    <input type="text" id="gameNameInput" class="form-control" placeholder="輸入遊戲名稱" maxlength="50">
                </div>
                <div class="form-group">
                    <label class="form-label">創建者名稱</label>
                    <input type="text" id="creatorNameInput" class="form-control" placeholder="輸入創建者名稱" maxlength="20">
                </div>
                <div class="modal-actions">
                    <button class="btn btn--secondary" onclick="closeCreateGameModal()">取消</button>
                    <button class="btn btn--primary" onclick="confirmCreateGame()">創建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Amount Input Modal -->
    <div id="amountModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">記錄輸贏</h3>
                <button class="modal-close" onclick="closeAmountModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">金額 (正數為贏，負數為輸)</label>
                    <input type="number" id="amountInput" class="form-control" placeholder="輸入整數金額">
                </div>
                <div class="modal-actions">
                    <button class="btn btn--secondary" onclick="closeAmountModal()">取消</button>
                    <button class="btn btn--primary" onclick="confirmAmount()">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div id="editRecordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editModalTitle">編輯記錄</h3>
                <button class="modal-close" onclick="closeEditRecordModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">金額 (正數為贏，負數為輸)</label>
                    <input type="number" id="editAmountInput" class="form-control" placeholder="輸入整數金額">
                </div>
                <div class="modal-actions">
                    <button class="btn btn--secondary" onclick="closeEditRecordModal()">取消</button>
                    <button class="btn btn--primary" onclick="confirmEditRecord()">確認修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div id="addPlayerModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新玩家</h3>
                <button class="modal-close" onclick="closeAddPlayerModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">玩家名稱</label>
                    <input type="text" id="newPlayerNameInput" class="form-control" placeholder="輸入玩家名稱" maxlength="20">
                </div>
                <div class="modal-actions">
                    <button class="btn btn--secondary" onclick="closeAddPlayerModal()">取消</button>
                    <button class="btn btn--primary" onclick="confirmAddPlayer()">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>數據衝突解決</h3>
                <button class="modal-close" onclick="closeConflictModal()">✕</button>
            </div>
            <div class="modal-body">
                <p>檢測到本地和雲端數據存在衝突，請選擇要保留的版本：</p>
                <div class="conflict-options">
                    <div class="conflict-option">
                        <h4>本地版本</h4>
                        <p id="localVersionInfo">最後修改：--</p>
                        <button class="btn btn--outline btn--full-width" onclick="resolveConflict('local')">保留本地版本</button>
                    </div>
                    <div class="conflict-option">
                        <h4>雲端版本</h4>
                        <p id="cloudVersionInfo">最後修改：--</p>
                        <button class="btn btn--outline btn--full-width" onclick="resolveConflict('cloud')">保留雲端版本</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn--secondary" onclick="closeConflictModal()">稍後決定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="toast hidden">
        <span id="toastMessage">操作成功</span>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator hidden">
        <span>⚠️ 離線模式 - 數據將在網路恢復後同步</span>
    </div>

    <script src="app.js"></script>
</body>
</html>